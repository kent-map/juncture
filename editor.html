<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Juncture Editor</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <style>
      body { font-family: Roboto, sans-serif; }
      textarea { opacity: 0; }
      .EasyMDEContainer .CodeMirror-wrap { height: calc(100dvh - 80px); }
      .EasyMDEContainer .CodeMirror-code { font-size: 1.2em; }
      article.j1 { height: unset; }
      @media (min-width: 800px) { .j1 .viewers { height: calc(100dvh - 192px); } }
      .CodeMirror-line .cm-header { font-size: 1.4em; }
    </style>
  </head>
  <body>

    <ve-header title="Editor" auth="github"></ve-header>
    <ve-gh-file-selector id="gh-selector" :gh-source="ghSource"></ve-gh-file-selector>
    <textarea id="md-text"></textarea>
    
    <script src="https://v3.juncture-digital.org/wc/dist/js/index.js" type="module"></script>
    <script type="module">
      import { getMarkdown } from 'https://v3.juncture-digital.org/index.js'

      const sourceArg = new URL(location.href).searchParams.get('source')
      const referrer = document.referrer && new URL(document.referrer)
      
      if (!sourceArg && referrer) {
        // redirect to editor with source query if referrer is a markdown file
        let [acct, repo, branch, ...path] = referrer.pathname.split('/').filter(pe => pe && pe !== 'blob' && pe !== 'tree')
        window.location.href = `${window.location.origin}/editor?source=${`${acct}/${repo}/${branch || 'main'}/${path.join('/')}`}`
      } 

      let ghSource
      if (sourceArg) {
        let [acct, repo, branch, ...path] = sourceArg.split('/').filter(pe => pe)
        ghSource = `${acct}/${repo}/${branch}/${path.join('/')}`
        document.getElementById('gh-selector').setAttribute('gh-source', ghSource)
      }

      init()

      function init() {

        document.getElementById('gh-selector').addEventListener('file-selected', e => {
          let ghSource = e.detail[0]
          window.history.replaceState({}, null, `/editor?source=${ghSource}`)
          getMarkdown(ghSource).then(markdown => easymde.value(markdown))
          styleJunctureElements()
        })

        const easymde = new EasyMDE({
          element: document.getElementById('md-text'),
          previewRender: togglePreview,
          spellChecker: false,
          toolbar: [
            ...[
              ...['undo', 'redo', '|','bold', 'italic', 'heading', 'quote'],
              ...['unordered-list', 'ordered-list', 'link']
            ], 
            ...[           
              '|', 
              'preview',
              {
              class: 'save',
                action: () => {this.saveFile()},
                className: 'fa fa-download',
                title: 'Save file',
                attributes: {id: 'save'}
              }, {
              class: 'copy',
                action: () => {this.copyText()},
                className: 'fa fa-copy',
                title: 'Copy text',
                attributes: {id: 'copy'}
              }, { 
                class: 'Share',
                action: () => {this.share()},
                className: 'fa fa-share',
                title: 'Share',
                attributes: {id: 'share'}
              }
            ]
          ]
        })
      }

      function togglePreview(md, preview) {
        return `<ve-article><pre>${md}</pre></ve-article>`
      }

      function styleJunctureElements() {
        setTimeout(() =>
          document.querySelector('.EasyMDEContainer').querySelectorAll('span.cm-formatting-code + span.cm-comment').forEach((el, i) => {
            el.style.color = 'red'
        }), 100)
      }
    
    </script>
  </body>
</html>
